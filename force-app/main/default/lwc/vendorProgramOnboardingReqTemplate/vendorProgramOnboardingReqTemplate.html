<template>
  <lightning-card title={cardTitle}>
    <div class="slds-p-around_medium">
      <template if:true={isLoading}>
        <lightning-spinner size="small"></lightning-spinner>
      </template>

      <template if:false={isLoading}>
        <div class="slds-box slds-box_x-small slds-theme_info slds-m-bottom_small" style="padding: 0.5rem;">
          <div class="slds-media">
            <div class="slds-media__figure">
              <lightning-icon icon-name="utility:info" size="xx-small" alternative-text="Info"></lightning-icon>
            </div>
            <div class="slds-media__body">
              <p class="slds-text-body_small slds-m-bottom_x-small">
                <strong>Requirement Template:</strong> Defines a specific requirement that vendors must complete. Templates are created within a Requirement Set and can be linked to a Requirement Group.
              </p>
              <p class="slds-text-body_small slds-m-bottom_none">
                <strong>Requirement Label:</strong> This is the descriptive name that appears in lists and dropdowns (e.g., "Business License" or "W9 Tax Form"). 
                The auto-number Name field (e.g., "ORT-00001") is not user-friendly, so always set a clear, descriptive Requirement Label when creating templates.
              </p>
            </div>
          </div>
        </div>

        <template if:false={requirementSetId}>
          <div class="slds-box slds-theme_error slds-m-bottom_small" style="padding: 0.75rem;">
            <p class="slds-text-body_regular slds-text-color_error">
              <strong>Error:</strong> No Requirement Set selected. Please go back and select or create a Requirement Set first.
            </p>
          </div>
        </template>

        <template if:true={requirementSetId}>
          <!-- Create/Edit Template Form -->
          <p class="slds-text-heading_small slds-m-bottom_small">{formTitle}</p>
          
          <div class="slds-m-bottom_small">
            <lightning-input 
              label="Requirement Label" 
              name="Requirement_Label__c"
              value={newTemplate.Requirement_Label__c} 
              onchange={handleFieldChange}
              placeholder="e.g., Business License, W9 Tax Form"
              required
              class="slds-m-bottom_small">
            </lightning-input>
            <p class="slds-text-body_small slds-text-color_weak slds-m-left_small">
              <lightning-icon icon-name="utility:info" size="xx-small" alternative-text="Info"></lightning-icon>
              <strong>What is this?</strong> A user-friendly name that identifies the requirement. Use clear, descriptive labels like "W9 Tax Form" or "Business License Certificate".
            </p>
          </div>

          <div class="slds-m-bottom_small">
            <lightning-combobox
              label="Requirement Type"
              name="Requirement_Type__c"
              value={newTemplate.Requirement_Type__c}
              options={requirementTypeOptions}
              onchange={handleFieldChange}
              class="slds-m-bottom_small"
              required>
            </lightning-combobox>
            <p class="slds-text-body_small slds-text-color_weak slds-m-left_small">
              <lightning-icon icon-name="utility:info" size="xx-small" alternative-text="Info"></lightning-icon>
              <strong>What is this?</strong> Categorizes the requirement. Common types: Document (files to upload), Training (courses to complete), Credential (certifications), or Status (status updates).
            </p>
          </div>

          <div class="slds-m-bottom_small">
            <lightning-combobox
              label="Status"
              name="Status__c"
              value={newTemplate.Status__c}
              options={statusOptions}
              onchange={handleFieldChange}
              class="slds-m-bottom_small"
              required>
            </lightning-combobox>
            <p class="slds-text-body_small slds-text-color_weak slds-m-left_small">
              <lightning-icon icon-name="utility:info" size="xx-small" alternative-text="Info"></lightning-icon>
              <strong>What is this?</strong> Controls whether this template is Active (available for use), Inactive (hidden), or Draft (work in progress).
            </p>
          </div>

          <div class="slds-m-bottom_small">
            <lightning-input
              type="checkbox"
              label="Is Current Version"
              name="Is_Current_Version__c"
              checked={newTemplate.Is_Current_Version__c}
              onchange={handleFieldChange}
              class="slds-m-bottom_small">
            </lightning-input>
            <p class="slds-text-body_small slds-text-color_weak slds-m-left_small">
              <lightning-icon icon-name="utility:info" size="xx-small" alternative-text="Info"></lightning-icon>
              <strong>What is this?</strong> When checked, this is the active version of the template. Only current versions are used when creating new requirements. Uncheck this if you create a new version to replace this one.
            </p>
          </div>

          <div class="slds-m-bottom_small">
            <lightning-input
              type="checkbox"
              label="Active"
              name="Active__c"
              checked={newTemplate.Active__c}
              onchange={handleFieldChange}
              class="slds-m-bottom_small">
            </lightning-input>
            <p class="slds-text-body_small slds-text-color_weak slds-m-left_small">
              <lightning-icon icon-name="utility:info" size="xx-small" alternative-text="Info"></lightning-icon>
              <strong>What is this?</strong> Indicates if this template is active. This is automatically set to TRUE when Status is set to "Active" (DRY pattern applied system-wide).
            </p>
          </div>

          <lightning-input
            label="Description"
            name="Description__c"
            value={newTemplate.Description__c}
            onchange={handleFieldChange}
            placeholder="Optional description of this requirement template"
            class="slds-m-bottom_small">
          </lightning-input>

          <lightning-combobox
            label="Default Status Options"
            name="Default_Status_Options__c"
            value={newTemplate.Default_Status_Options__c}
            options={statusOptions}
            onchange={handleFieldChange}
            placeholder="Select default status (optional)..."
            class="slds-m-bottom_small">
          </lightning-combobox>
          <p class="slds-text-body_small slds-text-color_weak slds-m-left_small slds-m-bottom_small">
            <lightning-icon icon-name="utility:info" size="xx-small" alternative-text="Info"></lightning-icon>
            <strong>What is this?</strong> The default status value to use when creating requirements from this template.
          </p>

          <template if:true={isEditing}>
            <lightning-input
              label="Version"
              name="Version__c"
              value={newTemplate.Version__c}
              disabled
              readonly
              class="slds-m-bottom_small">
            </lightning-input>
            <p class="slds-text-body_small slds-text-color_weak slds-m-left_small">
              <lightning-icon icon-name="utility:info" size="xx-small" alternative-text="Info"></lightning-icon>
              <strong>What is this?</strong> Version number is automatically set to prevent duplicates. This field is read-only and managed by the system.
            </p>

            <lightning-input
              label="Previous Version"
              name="Previous_Version__c"
              value={newTemplate.Previous_Version__c}
              disabled
              readonly
              class="slds-m-bottom_small">
            </lightning-input>
            <p class="slds-text-body_small slds-text-color_weak slds-m-left_small slds-m-bottom_small">
              <lightning-icon icon-name="utility:info" size="xx-small" alternative-text="Info"></lightning-icon>
              <strong>What is this?</strong> Reference to the previous version of this template (if this is a versioned update). Managed by the system.
            </p>
          </template>

          <!-- Field Mapping Section (Admin Only) -->
          <template if:true={showFieldMappingUI}>
            <div class="slds-box slds-theme_shade slds-m-top_medium slds-m-bottom_medium" style="padding: 1rem;">
              <h3 class="slds-text-heading_small slds-m-bottom_small">
                <lightning-icon icon-name="utility:settings" size="small" alternative-text="Settings"></lightning-icon>
                Map to Onboarding Status Field (Admin Only - Optional)
              </h3>
              <div class="slds-box slds-theme_info slds-m-bottom_medium" style="padding: 0.75rem;">
                <p class="slds-text-body_small slds-m-bottom_small">
                  <strong>What is Field Mapping?</strong> This advanced feature allows you to link this requirement template to a specific status field on the Onboarding record. When configured, the Status Rules Engine can automatically evaluate requirement completion based on the Onboarding record's status values.
                </p>
                <p class="slds-text-body_small slds-m-bottom_none">
                  <strong>Example:</strong> If "W9 Tax Form" requirement should be considered complete when the Onboarding record's "W9_Status__c" field equals "Approved" or "Approved Box 1", you would:
                  <br />1. Select "W9 Status" from the dropdown below
                  <br />2. Move "Approved" and "Approved Box 1" to "Complete When Status Is"
                  <br />3. Optionally, move "Denied" to "Denied When Status Is" if needed for denial logic
                </p>
              </div>
            
              <div class="slds-m-bottom_small">
                <lightning-combobox
                  label="Onboarding Status Field"
                  value={selectedOnboardingFieldApiName}
                  options={onboardingFieldOptions}
                  onchange={handleOnboardingFieldChange}
                  placeholder="Select a field to map (optional)..."
                  class="slds-m-bottom_small"
                  disabled={isLoadingOnboardingFields}>
                </lightning-combobox>
                <p class="slds-text-body_small slds-text-color_weak slds-m-left_small">
                  <lightning-icon icon-name="utility:info" size="xx-small" alternative-text="Info"></lightning-icon>
                  <strong>What is this?</strong> Choose a picklist field from the Onboarding__c object. Only fields that aren't already mapped by other templates are shown. This is optional - leave blank if you don't need status-based evaluation.
                </p>
              </div>

              <template if:true={isLoadingPicklistValues}>
                <lightning-spinner size="small" alternative-text="Loading picklist values"></lightning-spinner>
              </template>

              <template if:true={showFieldMappingSection}>
                <div class="slds-m-top_medium">
                  <lightning-dual-listbox
                    label="Status Values That Indicate Completion"
                    source-label="Available Status Values"
                    selected-label="Complete When Status Is"
                    options={completionStatusOptions}
                    value={selectedCompletionStatusValues}
                    onchange={handleCompletionStatusChange}
                    min="0"
                    class="slds-m-bottom_small">
                  </lightning-dual-listbox>
                  <p class="slds-text-body_small slds-text-color_weak slds-m-left_small slds-m-bottom_medium">
                    <lightning-icon icon-name="utility:info" size="xx-small" alternative-text="Info"></lightning-icon>
                    <strong>What is this?</strong> Select one or more status values that indicate this requirement is <strong>complete</strong>. For legacy fields with multiple approved states (e.g., "Onboarding Approved", "Approved Box 1", "Approved Box 2"), select all relevant values.
                  </p>
                  
                  <lightning-dual-listbox
                    label="Status Values That Indicate Denial (Optional)"
                    source-label="Available Status Values"
                    selected-label="Denied When Status Is"
                    options={completionStatusOptions}
                    value={selectedDeniedStatusValues}
                    onchange={handleDeniedStatusChange}
                    min="0"
                    class="slds-m-bottom_small">
                  </lightning-dual-listbox>
                  <p class="slds-text-body_small slds-text-color_weak slds-m-left_small">
                    <lightning-icon icon-name="utility:info" size="xx-small" alternative-text="Info"></lightning-icon>
                    <strong>What is this?</strong> (Optional) Select status values that indicate this requirement is <strong>denied</strong>. This can be used by the Status Rules Engine for override logic. Leave empty if denial status is not needed.
                  </p>
                </div>
              </template>

              <template if:false={hasFieldMapping}>
                <p class="slds-text-body_small slds-text-color_weak slds-m-top_x-small">
                  <lightning-icon icon-name="utility:info" size="xx-small" alternative-text="Info"></lightning-icon>
                  Select an Onboarding status field above to configure completion and denial status values. This mapping is optional and only needed if you want the rules engine to automatically check completion based on the Onboarding record's status.
                </p>
              </template>
            </div>
          </template>

          <!-- Create/Update Template Buttons -->
          <div class="slds-m-top_medium slds-m-bottom_medium">
            <template if:false={isEditing}>
              <lightning-button 
                variant="brand" 
                label="Create Template" 
                onclick={handleCreateTemplate} 
                disabled={nextDisabled}
                class="slds-m-right_small">
              </lightning-button>
              <p class="slds-text-body_small slds-text-color_weak slds-m-top_x-small">
                The template will be added to "Available Templates" below. You can create multiple templates without leaving this screen.
              </p>
            </template>
            <template if:true={isEditing}>
              <lightning-button 
                variant="brand" 
                label="Save Changes" 
                onclick={handleSaveEdit} 
                disabled={nextDisabled}
                class="slds-m-right_small">
              </lightning-button>
              <lightning-button 
                variant="neutral" 
                label="Cancel" 
                onclick={handleCancelEdit}
                class="slds-m-right_small">
              </lightning-button>
              <p class="slds-text-body_small slds-text-color_weak slds-m-top_x-small">
                Saving will update the template. Click Cancel to discard changes.
              </p>
            </template>
          </div>

          <!-- Saved Templates Section with Group Selection and Dual-Listbox -->
          <div class="slds-box slds-theme_default slds-m-top_medium slds-m-bottom_medium" style="padding: 1rem;">
            <h3 class="slds-text-heading_small slds-m-bottom_small">Saved Templates & Group Linking</h3>
            
            <!-- Group Selection Dropdown -->
            <div class="slds-m-bottom_medium">
              <lightning-combobox
                label="Select Requirement Group (required)"
                value={selectedGroupId}
                options={requirementGroupOptions}
                onchange={handleGroupSelect}
                placeholder="Select a group to link templates..."
                class="slds-m-bottom_small"
                disabled={isLoadingGroups}
                required>
              </lightning-combobox>
              
              <template if:false={hasRequirementGroups}>
                <p class="slds-text-body_small slds-text-color_weak slds-m-top_x-small">
                  <lightning-icon icon-name="utility:info" size="xx-small" alternative-text="Info"></lightning-icon>
                  No Requirement Groups available. Create a new one below.
                </p>
              </template>
              
              <template if:true={hasRequirementGroups}>
                <template if:false={hasSelectedGroup}>
                  <p class="slds-text-body_small slds-text-color_error slds-m-top_x-small">
                    <lightning-icon icon-name="utility:error" size="xx-small" alternative-text="Error"></lightning-icon>
                    <strong>Required:</strong> Please select a Requirement Group to continue.
                  </p>
                </template>
              </template>
              
              <template if:true={isGroupFromStep4}>
                <div class="slds-box slds-theme_success slds-m-top_small" style="padding: 0.5rem;">
                  <p class="slds-text-body_small slds-m-bottom_none">
                    <lightning-icon icon-name="utility:success" size="xx-small" alternative-text="Success"></lightning-icon>
                    <strong>Using Requirement Group from Step 4:</strong> {selectedGroupName}
                  </p>
                </div>
              </template>
              
              <template if:true={hasSelectedGroup}>
                <template if:false={isGroupFromStep4}>
                  <div class="slds-text-body_small slds-text-color_success slds-m-top_small">
                    âœ“ Requirement Group selected: <strong>{selectedGroupName}</strong>
                  </div>
                </template>
                
                <lightning-input
                  type="checkbox"
                  label="Automatically link new templates to selected group"
                  checked={autoLinkNewTemplates}
                  onchange={handleAutoLinkChange}
                  class="slds-m-top_small">
                </lightning-input>
                <p class="slds-text-body_small slds-text-color_weak slds-m-left_small slds-m-top_x-small">
                  When enabled, any new templates you create will be automatically linked to the selected group above.
                </p>
              </template>
              
              <!-- Create New Group Option -->
              <div class="slds-m-top_medium">
                <template if:false={showCreateGroupForm}>
                  <lightning-button
                    variant="neutral"
                    label="Create New Requirement Group"
                    icon-name="utility:add"
                    onclick={toggleCreateGroupForm}
                    class="slds-m-bottom_small">
                  </lightning-button>
                </template>
                
                <template if:true={showCreateGroupForm}>
                  <div class="slds-box slds-theme_shade slds-m-bottom_small" style="padding: 1rem;">
                    <p class="slds-text-heading_small slds-m-bottom_small">Create New Requirement Group</p>
                    
                    <lightning-input
                      label="Group Name"
                      value={newGroupName}
                      onchange={handleNewGroupNameChange}
                      placeholder="e.g., Standard Documentation, Healthcare Requirements"
                      required
                      class="slds-m-bottom_small">
                    </lightning-input>
                    
                    <lightning-combobox
                      label="Status"
                      value={newGroupStatus}
                      options={statusOptions}
                      onchange={handleNewGroupStatusChange}
                      required
                      class="slds-m-bottom_small">
                    </lightning-combobox>
                    
                    <div class="slds-m-top_small">
                      <lightning-button
                        variant="brand"
                        label="Create Group"
                        onclick={handleCreateGroup}
                        disabled={isCreateGroupButtonDisabled}
                        class="slds-m-right_small">
                      </lightning-button>
                      <lightning-button
                        variant="neutral"
                        label="Cancel"
                        onclick={toggleCreateGroupForm}
                        disabled={isCancelGroupButtonDisabled}>
                      </lightning-button>
                    </div>
                  </div>
                </template>
              </div>
            </div>

            <!-- Templates List with Edit Options (Admin Only) -->
            <template if:true={showFieldMappingUI}>
              <template if:true={hasTemplates}>
                <div class="slds-box slds-theme_default slds-m-top_medium slds-m-bottom_medium" style="padding: 1rem;">
                  <h3 class="slds-text-heading_small slds-m-bottom_small">Edit Existing Templates (Admin Only)</h3>
                  <p class="slds-text-body_small slds-text-color_weak slds-m-bottom_small">
                    Click "Edit" on any template below to modify its settings, including field mappings, requirement type, status, and more.
                  </p>
                  <template for:each={templates} for:item="template">
                    <div key={template.Id} class="slds-box slds-box_x-small slds-m-bottom_small" style="padding: 0.75rem;">
                      <div class="slds-grid slds-grid_align-spread slds-grid_vertical-align-center">
                        <div class="slds-col slds-grid slds-grid_vertical-align-center">
                          <div>
                            <p class="slds-text-body_regular slds-text-heading_small">
                              <strong>{template.Requirement_Label__c}</strong>
                            </p>
                            <p class="slds-text-body_small slds-text-color_weak">
                              Type: {template.Requirement_Type__c} | Status: {template.Status__c}
                              <template if:true={template.Onboarding_Status_Field_API_Name__c}>
                                | Mapped to: {template.Onboarding_Status_Field_API_Name__c}
                              </template>
                            </p>
                          </div>
                        </div>
                        <div class="slds-col slds-no-flex">
                          <lightning-button
                            variant="neutral"
                            label="Edit"
                            icon-name="utility:edit"
                            data-id={template.Id}
                            onclick={handleEditTemplate}
                            class="slds-m-left_small">
                          </lightning-button>
                        </div>
                      </div>
                    </div>
                  </template>
                </div>
              </template>
            </template>

            <!-- Dual-listbox for Template Selection -->
            <template if:true={hasTemplates}>
              <p class="slds-text-body_small slds-text-color_weak slds-m-bottom_small">
                <template if:true={hasSelectedGroup}>
                  Select templates below to link them to <strong>{selectedGroupName}</strong>. Changes are saved automatically.
                </template>
                <template if:false={hasSelectedGroup}>
                  Select a Requirement Group above to link templates to it. Templates you move to "Linked to Requirement Group" will be associated with that group.
                </template>
              </p>
              
              <lightning-dual-listbox
                label="Select Templates to Link to Requirement Group"
                source-label="Available Templates"
                selected-label="Linked to Requirement Group"
                options={templateOptions}
                value={selectedTemplateIds}
                onchange={handleTemplateSelectionChange}
                min="0"
                disabled={isDualListboxDisabled}>
              </lightning-dual-listbox>
              
              <template if:false={hasSelectedGroup}>
                <p class="slds-text-body_small slds-text-color_weak slds-m-top_small">
                  <lightning-icon icon-name="utility:info" size="xx-small" alternative-text="Info"></lightning-icon>
                  Please select a Requirement Group above to enable template linking.
                </p>
              </template>
            </template>

            <!-- Empty State for Templates -->
            <template if:false={hasTemplates}>
              <div class="slds-box slds-theme_shade slds-m-top_small" style="padding: 1rem;">
                <p class="slds-text-body_small slds-text-color_weak slds-text-align_center">
                  No requirement templates yet in this Requirement Set. Create your first template using the form above.
                </p>
              </div>
            </template>
          </div>

          <!-- Navigation buttons removed - handled by flow engine footer -->
          <template if:true={cannotContinue}>
            <p class="slds-text-body_small slds-text-color_error slds-m-top_small">
              <lightning-icon icon-name="utility:error" size="xx-small" alternative-text="Error"></lightning-icon>
              Please select or create a Requirement Group to continue.
            </p>
          </template>
        </template>
      </template>
    </div>
  </lightning-card>
</template>
