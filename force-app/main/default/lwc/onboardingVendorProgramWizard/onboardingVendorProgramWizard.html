<template>
    <!-- Vendor Program Onboarding Modal -->
    <section role="dialog" tabindex="-1" aria-labelledby="vendor-program-modal-heading" aria-modal="true" 
             aria-describedby="vendor-program-modal-content" class="slds-modal slds-fade-in-open">
        <div class="slds-modal__container vendor-program-modal-large">
            <header class="slds-modal__header">
                <button class="slds-button slds-button_icon slds-modal__close slds-button_icon-inverse" 
                        title="Close" onclick={handleClose}>
                    <lightning-icon icon-name="utility:close" alternative-text="close" size="small"></lightning-icon>
                    <span class="slds-assistive-text">Close</span>
                </button>
                <h2 id="vendor-program-modal-heading" class="slds-modal__title slds-hyphenate">
                    <template if:true={isTreeGridStep}>Vendors & Programs</template>
                    <template if:true={isVendorSelectionStep}>Select or Create Vendor</template>
                    <template if:true={isVendorProgramSelectionStep}>Select Vendor Program</template>
                </h2>
            </header>
            <div class="slds-modal__content slds-p-around_medium" id="vendor-program-modal-content">
                
                <!-- Tree Grid Step: Select Vendor Program -->
                <template if:true={isTreeGridStep}>
                    <template if:true={isResumingOnboarding}>
                        <div class="slds-align_absolute-center slds-p-around_large">
                            <lightning-spinner alternative-text="Resuming onboarding..." size="medium"></lightning-spinner>
                            <p class="slds-text-align_center slds-m-top_medium slds-text-body_regular">Resuming onboarding process...</p>
                        </div>
                    </template>
                    <template if:false={isResumingOnboarding}>
                        <div class="slds-grid slds-gutter slds-m-bottom_small">
                            <div class="slds-col slds-size_3-of-4">
                                <lightning-input
                                    label="Search Vendors or Programs"
                                    value={vendorSearchText}
                                    onchange={handleVendorSearchChange}
                                    onkeydown={handleVendorSearchChange}
                                    placeholder="Type at least 2 characters, then pause or press Enter to search..."
                                    icon-name="utility:search">
                                </lightning-input>
                            </div>
                            <div class="slds-col slds-size_1-of-4 slds-align_absolute-center">
                                <lightning-button
                                    label="Create New"
                                    variant="brand"
                                    icon-name="utility:add"
                                    onclick={handleCreateNewVendorProgram}
                                    class="slds-m-top_large">
                                </lightning-button>
                            </div>
                        </div>
                        <template if:true={isVendorHierarchyLoading}>
                            <div class="slds-align_absolute-center slds-p-around_large">
                                <lightning-spinner alternative-text="Loading vendors and programs..." size="medium"></lightning-spinner>
                            </div>
                        </template>
                        <template if:false={isVendorHierarchyLoading}>
                            <template if:true={vendorHierarchy.length}>
                                <lightning-tree-grid
                                    key-field="id"
                                    data={vendorHierarchy}
                                    columns={vendorHierarchyColumns}
                                    onrowaction={handleVendorHierarchyRowAction}
                                    expanded-rows={expandedVendorRows}
                                    hide-checkbox-column>
                                </lightning-tree-grid>
                            </template>
                            <template if:false={vendorHierarchy.length}>
                                <div class="slds-text-align_center slds-p-around_large">
                                    <p class="slds-text-body_regular">
                                        <template if:true={vendorSearchText}>
                                            No vendors or programs found matching "{vendorSearchText}".
                                        </template>
                                        <template if:false={vendorSearchText}>
                                            No vendors found. Click "Create New" to create a new vendor program.
                                        </template>
                                    </p>
                                </div>
                            </template>
                        </template>
                    </template>
                </template>

                <!-- Vendor Selection Step: Select or Create Vendor -->
                <template if:true={isVendorSelectionStep}>
                    <p class="slds-text-body_regular slds-m-bottom_medium">
                        Select an existing vendor or create a new one to continue with vendor program creation.
                    </p>
                    
                    <!-- Search Existing Vendors -->
                    <div class="slds-form-element slds-m-bottom_medium">
                        <label class="slds-form-element__label" for="vendor-search">
                            Search for Existing Vendor
                        </label>
                        <div class="slds-form-element__control">
                            <div class="slds-grid slds-gutter_x-small">
                                <div class="slds-col slds-size_3-of-4">
                                    <lightning-input
                                        id="vendor-search"
                                        type="text"
                                        value={vendorSearchText}
                                        onchange={handleVendorSearchChange}
                                        placeholder="Enter vendor name">
                                    </lightning-input>
                                </div>
                                <div class="slds-col slds-size_1-of-4">
                                    <lightning-button
                                        label="Search"
                                        variant="neutral"
                                        onclick={handleSearchVendors}
                                        disabled={isVendorSearching}
                                        icon-name="utility:search">
                                    </lightning-button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Vendor Search Results -->
                    <template if:true={vendors.length}>
                        <div class="slds-form-element slds-m-bottom_medium">
                            <label class="slds-form-element__label">
                                <abbr class="slds-required" title="required">*</abbr> Select Vendor
                            </label>
                            <div class="slds-form-element__control">
                                <lightning-radio-group
                                    name="vendor-selection"
                                    options={vendorOptions}
                                    value={selectedVendorId}
                                    type="radio"
                                    onchange={handleVendorSelect}>
                                </lightning-radio-group>
                            </div>
                        </div>
                    </template>

                    <!-- Or Create New Vendor -->
                    <div class="slds-divider slds-m-vertical_medium">
                        <span class="slds-text-body_small slds-p-horizontal_medium">OR</span>
                    </div>

                    <div class="slds-form-element slds-m-bottom_medium">
                        <label class="slds-form-element__label" for="new-vendor-name">
                            Create New Vendor
                        </label>
                        <div class="slds-form-element__control">
                            <div class="slds-grid slds-gutter_x-small">
                                <div class="slds-col slds-size_3-of-4">
                                    <lightning-input
                                        id="new-vendor-name"
                                        type="text"
                                        value={newVendorName}
                                        onchange={handleCreateVendorChange}
                                        placeholder="Enter new vendor name">
                                    </lightning-input>
                                </div>
                                <div class="slds-col slds-size_1-of-4">
                                    <lightning-button
                                        label="Create & Continue"
                                        variant="brand"
                                        onclick={handleCreateVendor}
                                        disabled={isCreatingVendor}
                                        icon-name="utility:add">
                                    </lightning-button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Selected Vendor Display -->
                    <template if:true={selectedVendorId}>
                        <div class="slds-box slds-theme_success slds-m-top_medium">
                            <div class="slds-media">
                                <div class="slds-media__figure">
                                    <lightning-icon icon-name="utility:success" size="small"></lightning-icon>
                                </div>
                                <div class="slds-media__body">
                                    <p class="slds-text-body_small">
                                        <strong>Vendor Selected:</strong> 
                                        <template if:true={selectedVendorId}>
                                            {selectedVendorName}
                                        </template>
                                    </p>
                                </div>
                            </div>
                        </div>
                    </template>
                </template>

                <!-- Vendor Program Selection Step: Select Existing Vendor Program -->
                <template if:true={isVendorProgramSelectionStep}>
                    <p class="slds-text-body_regular slds-m-bottom_medium">
                        Select an existing vendor program to continue onboarding or make updates.
                    </p>
                    
                    <!-- Recent Vendor Programs -->
                    <template if:true={recentVendorPrograms.length}>
                        <div class="slds-form-element slds-m-bottom_medium">
                            <label class="slds-form-element__label">
                                Recent Vendor Programs
                            </label>
                            <div class="slds-form-element__control">
                                <lightning-radio-group
                                    name="recent-vendor-program-selection"
                                    options={recentVendorProgramOptions}
                                    value={selectedVendorProgramId}
                                    type="radio"
                                    onchange={handleVendorProgramSelect}>
                                </lightning-radio-group>
                            </div>
                        </div>
                    </template>

                    <!-- Search Vendor Programs -->
                    <div class="slds-form-element slds-m-bottom_medium">
                        <label class="slds-form-element__label" for="vendor-program-search">
                            Search for Vendor Program
                        </label>
                        <div class="slds-form-element__control">
                            <div class="slds-grid slds-gutter_x-small">
                                <div class="slds-col slds-size_3-of-4">
                                    <lightning-input
                                        id="vendor-program-search"
                                        type="text"
                                        value={vendorProgramSearchText}
                                        onchange={handleVendorProgramSearchChange}
                                        placeholder="Enter vendor program name">
                                    </lightning-input>
                                </div>
                                <div class="slds-col slds-size_1-of-4">
                                    <lightning-button
                                        label="Search"
                                        variant="neutral"
                                        onclick={handleSearchVendorPrograms}
                                        disabled={isVendorProgramSearching}
                                        icon-name="utility:search">
                                    </lightning-button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Vendor Program Search Results -->
                    <template if:true={vendorPrograms.length}>
                        <div class="slds-form-element slds-m-bottom_medium">
                            <label class="slds-form-element__label">
                                <abbr class="slds-required" title="required">*</abbr> Select Vendor Program
                            </label>
                            <div class="slds-form-element__control">
                                <lightning-radio-group
                                    name="vendor-program-selection"
                                    options={vendorProgramOptions}
                                    value={selectedVendorProgramId}
                                    type="radio"
                                    onchange={handleVendorProgramSelect}>
                                </lightning-radio-group>
                            </div>
                        </div>
                    </template>
                </template>
            </div>
            <footer class="slds-modal__footer">
                <template if:false={isTreeGridStep}>
                    <lightning-button 
                        variant="neutral" 
                        label="Back" 
                        onclick={handleBackToTreeGrid}
                        class="slds-m-right_small">
                    </lightning-button>
                </template>
                <lightning-button 
                    variant="neutral" 
                    label="Cancel" 
                    onclick={handleClose}>
                </lightning-button>
                <template if:true={isVendorSelectionStep}>
                    <lightning-button 
                        variant="brand" 
                        label="Continue" 
                        onclick={handleProceedWithVendor}
                        disabled={disableVendorContinue}>
                    </lightning-button>
                </template>
                <template if:true={isVendorProgramSelectionStep}>
                    <lightning-button 
                        variant="brand" 
                        label="Continue" 
                        onclick={handleProceedWithVendorProgram}
                        disabled={disableVendorProgramContinue}>
                    </lightning-button>
                </template>
            </footer>
        </div>
    </section>
    <div class="slds-backdrop slds-backdrop_open"></div>
</template>


