<template>
    <lightning-card>
        <!-- Header Section -->
        <div class="slds-p-horizontal_medium slds-p-top_medium">
            <div class="slds-grid slds-grid_align-spread slds-m-bottom_medium">
                <div>
                    <h1 class="slds-text-heading_large">Onboarding Home</h1>
                    <p class="slds-text-body_small slds-text-color_weak slds-m-top_xx-small">
                        Dealer & Vendor Program Onboarding Overview
                    </p>
                </div>
                <div>
                    <c-onboarding-filter-chips
                        time-filter={filters.timeRange}
                        vendor-filter={filters.vendors}
                        program-filter={filters.programs}
                        view-filter={filters.view}
                        show-team-view={showTeamView}
                        onfilterchange={handleFilterChange}>
                    </c-onboarding-filter-chips>
                </div>
            </div>

            <!-- Quick Actions -->
            <div class="slds-grid slds-gutter slds-m-bottom_medium">
                <div class="slds-col slds-size_1-of-1">
                    <lightning-button 
                        label="Start Onboarding Vendor Program" 
                        variant="brand" 
                        icon-name="utility:add"
                        onclick={handleStartVendorProgramOnboarding}
                        class="slds-m-right_small">
                    </lightning-button>
                    <lightning-button 
                        label="Start Dealer Onboarding" 
                        variant="brand" 
                        icon-name="utility:user"
                        onclick={handleStartDealerOnboarding}
                        class="slds-m-right_small">
                    </lightning-button>
                    <lightning-button 
                        label="Sync Component Library" 
                        variant="neutral" 
                        icon-name="utility:sync"
                        onclick={handleSyncComponentLibrary}
                        disabled={isSyncingComponentLibrary}
                        title="Populates Onboarding_Component_Library__c with all 14 wizard components"
                        class="slds-m-right_small">
                    </lightning-button>
                    <lightning-button 
                        label="Initialize Default Process" 
                        variant="neutral" 
                        icon-name="utility:flow"
                        onclick={handleInitializeDefaultProcess}
                        disabled={isInitializingProcess}
                        title="Creates the default 'Vendor Program Onboarding' process with all 14 stages if it doesn't exist"
                        class="slds-m-right_small">
                    </lightning-button>
                    <lightning-button 
                        label="Refresh" 
                        variant="neutral" 
                        icon-name="utility:refresh"
                        onclick={handleRefresh}>
                    </lightning-button>
                </div>
            </div>
        </div>

        <!-- Loading Spinner -->
        <template if:true={isLoading}>
            <div class="slds-align_absolute-center slds-p-around_large">
                <lightning-spinner alternative-text="Loading..." size="medium"></lightning-spinner>
            </div>
        </template>

        <!-- Dashboard Content -->
        <template if:false={isLoading}>
            <!-- KPI Row -->
            <c-onboarding-kpi-row
                summary={onboardingSummary}
                vendor-summary={vendorSummary}
                blocked-count={blockedCount}
                ontileclick={handleKpiTileClick}>
            </c-onboarding-kpi-row>

            <!-- Main Content Area with Tabs -->
            <div class="slds-grid slds-gutters_medium slds-p-horizontal_medium">
                <!-- Main Content (2/3 width) -->
                <div class="slds-col slds-size_2-of-3">
                    <lightning-tabset active-tab-value={activeTab} onactive={handleTabChange}>
                        <lightning-tab label="My Active Onboarding" value="my-onboarding">
                            <c-onboarding-work-queue
                                records={activeOnboarding}
                                show-blocking-indicators={showBlockingIndicators}
                                onview={handleViewOnboarding}
                                onresume={handleResumeOnboarding}
                                onviewrequirements={handleViewRequirements}>
                            </c-onboarding-work-queue>
                        </lightning-tab>

                        <lightning-tab label="Eligible Dealers" value="eligible">
                            <lightning-datatable
                                key-field="Id"
                                data={eligibleAccounts}
                                columns={eligibleAccountsColumns}
                                onrowaction={handleEligibleAccountsRowAction}
                                hide-checkbox-column
                                show-row-number-column>
                            </lightning-datatable>
                        </lightning-tab>

                        <lightning-tab label="Vendor Programs" value="programs">
                            <c-onboarding-vendor-program-grid
                                programs={vendorPrograms}
                                onviewprogram={handleViewProgram}
                                onlaunchwizard={handleLaunchWizard}>
                            </c-onboarding-vendor-program-grid>
                        </lightning-tab>

                        <template if:true={showTeamTab}>
                            <lightning-tab label="Team / Org Queue" value="team">
                                <c-onboarding-work-queue
                                    records={teamQueue}
                                    show-blocking-indicators={showBlockingIndicators}
                                    onview={handleViewOnboarding}
                                    onresume={handleResumeOnboarding}
                                    onviewrequirements={handleViewRequirements}>
                                </c-onboarding-work-queue>
                            </lightning-tab>
                        </template>

                        <lightning-tab label="Insights" value="insights">
                            <template if:true={hasInsightsComponent}>
                                <c-onboarding-insights
                                    summary={onboardingSummary}
                                    vendor-program-metrics={vendorProgramMetrics}>
                                </c-onboarding-insights>
                            </template>
                            <template if:false={hasInsightsComponent}>
                                <div class="slds-text-align_center slds-p-around_large">
                                    <p class="slds-text-body_regular">Insights coming soon.</p>
                                </div>
                            </template>
                        </lightning-tab>
                    </lightning-tabset>
                </div>

                <!-- Sidebar (1/3 width) -->
                <div class="slds-col slds-size_1-of-3">
                    <lightning-card title="Recent Activity" icon-name="utility:clock">
                        <c-onboarding-recent-activity
                            activities={recentActivity}
                            onview={handleViewOnboarding}>
                        </c-onboarding-recent-activity>
                    </lightning-card>
                </div>
            </div>

            <!-- Admin Configuration Shortcuts -->
            <template if:true={showAdminSection}>
                <div class="slds-p-horizontal_medium slds-m-top_large">
                    <lightning-card title="Admin Tools" icon-name="utility:settings">
                        <lightning-tabset class="slds-m-bottom_medium">
                            <lightning-tab label="Validation Failures" value="validation-failures">
                                <div class="slds-m-bottom_small slds-text-align_right">
                                    <lightning-button variant="neutral" label="Open List" icon-name="utility:list" onclick={navigateToValidationFailuresList}></lightning-button>
                                </div>
                                <c-validation-failures-panel></c-validation-failures-panel>
                            </lightning-tab>
                            <lightning-tab label="Messaging Issues" value="messaging-issues">
                                <div class="slds-m-bottom_small slds-text-align_right">
                                    <lightning-button variant="neutral" label="Open List" icon-name="utility:list" onclick={navigateToMessagingIssuesList}></lightning-button>
                                </div>
                                <c-messaging-issues-panel></c-messaging-issues-panel>
                            </lightning-tab>
                            <lightning-tab label="Rule Tester" value="rule-tester">
                                <c-validation-rule-tester></c-validation-rule-tester>
                            </lightning-tab>
                            <lightning-tab label="Override Audit" value="override-audit">
                                <div class="slds-m-bottom_small slds-text-align_right">
                                    <lightning-button variant="neutral" label="Open List" icon-name="utility:list" onclick={navigateToOverrideAuditList}></lightning-button>
                                </div>
                                <c-override-audit-panel></c-override-audit-panel>
                            </lightning-tab>
                            <lightning-tab label="Rule Builder" value="rule-builder">
                                <c-requirement-rule-builder></c-requirement-rule-builder>
                            </lightning-tab>
                        </lightning-tabset>

                        <div class="slds-grid slds-wrap slds-gutters_medium">
                            <div class="slds-col slds-size_1-of-1 slds-medium-size_1-of-3 slds-large-size_1-of-5">
                                <div class="slds-box slds-text-align_center admin-card" onclick={handleManageRequirements}>
                                    <lightning-icon icon-name="utility:list" size="medium" class="slds-m-bottom_small"></lightning-icon>
                                    <div class="slds-text-body_small">Manage Requirements</div>
                                </div>
                            </div>
                            <div class="slds-col slds-size_1-of-1 slds-medium-size_1-of-3 slds-large-size_1-of-5">
                                <div class="slds-box slds-text-align_center admin-card" onclick={handleManageStatusRules}>
                                    <lightning-icon icon-name="utility:rules" size="medium" class="slds-m-bottom_small"></lightning-icon>
                                    <div class="slds-text-body_small">Manage Status Rules</div>
                                </div>
                            </div>
                            <div class="slds-col slds-size_1-of-1 slds-medium-size_1-of-3 slds-large-size_1-of-5">
                                <div class="slds-box slds-text-align_center admin-card" onclick={handleStageDependencies}>
                                    <lightning-icon icon-name="utility:flow" size="medium" class="slds-m-bottom_small"></lightning-icon>
                                    <div class="slds-text-body_small">Stage Dependencies</div>
                                </div>
                            </div>
                            <div class="slds-col slds-size_1-of-1 slds-medium-size_1-of-3 slds-large-size_1-of-5">
                                <div class="slds-box slds-text-align_center admin-card" onclick={handleVendorProgramWizard}>
                                    <lightning-icon icon-name="utility:setup" size="medium" class="slds-m-bottom_small"></lightning-icon>
                                    <div class="slds-text-body_small">Vendor Program Wizard</div>
                                </div>
                            </div>
                            <div class="slds-col slds-size_1-of-1 slds-medium-size_1-of-3 slds-large-size_1-of-5">
                                <div class="slds-box slds-text-align_center admin-card" onclick={handleComponentLibrary}>
                                    <lightning-icon icon-name="utility:apps" size="medium" class="slds-m-bottom_small"></lightning-icon>
                                    <div class="slds-text-body_small">Component Library</div>
                                </div>
                            </div>
                        </div>
                    </lightning-card>
                </div>
            </template>
        </template>
    </lightning-card>

    <!-- Vendor Program Onboarding Modal -->
    <template if:true={showVendorProgramModal}>
        <section role="dialog" tabindex="-1" aria-labelledby="vendor-program-modal-heading" aria-modal="true" 
                 aria-describedby="vendor-program-modal-content" class="slds-modal slds-fade-in-open">
            <div class="slds-modal__container vendor-program-modal-large">
                <header class="slds-modal__header">
                    <button class="slds-button slds-button_icon slds-modal__close slds-button_icon-inverse" 
                            title="Close" onclick={handleCloseVendorProgramModal}>
                        <lightning-icon icon-name="utility:close" alternative-text="close" size="small"></lightning-icon>
                        <span class="slds-assistive-text">Close</span>
                    </button>
                    <h2 id="vendor-program-modal-heading" class="slds-modal__title slds-hyphenate">
                        <template if:true={isTreeGridStep}>Vendors & Programs</template>
                        <template if:true={isVendorSelectionStep}>Select or Create Vendor</template>
                    </h2>
                </header>
                <div class="slds-modal__content slds-p-around_medium" id="vendor-program-modal-content">
                    
                    <!-- Tree Grid Step: Select Vendor Program -->
                    <template if:true={isTreeGridStep}>
                        <template if:true={isResumingOnboarding}>
                            <div class="slds-align_absolute-center slds-p-around_large">
                                <lightning-spinner alternative-text="Resuming onboarding..." size="medium"></lightning-spinner>
                                <p class="slds-text-align_center slds-m-top_medium slds-text-body_regular">Resuming onboarding process...</p>
                            </div>
                        </template>
                        <template if:false={isResumingOnboarding}>
                            <div class="slds-grid slds-gutter slds-m-bottom_small">
                                <div class="slds-col slds-size_3-of-4">
                                    <lightning-input
                                        label="Search Vendors or Programs"
                                        value={vendorSearchText}
                                        onchange={handleVendorSearchChange}
                                        placeholder="Type to search..."
                                        icon-name="utility:search">
                                    </lightning-input>
                                </div>
                                <div class="slds-col slds-size_1-of-4 slds-align_absolute-center">
                                    <lightning-button
                                        label="Create New"
                                        variant="brand"
                                        icon-name="utility:add"
                                        onclick={handleCreateNewVendorProgram}
                                        class="slds-m-top_large">
                                    </lightning-button>
                                </div>
                            </div>
                            <template if:true={isVendorHierarchyLoading}>
                                <div class="slds-align_absolute-center slds-p-around_large">
                                    <lightning-spinner alternative-text="Loading vendors and programs..." size="medium"></lightning-spinner>
                                </div>
                            </template>
                            <template if:false={isVendorHierarchyLoading}>
                                <template if:true={vendorHierarchy.length}>
                                    <lightning-tree-grid
                                        key-field="id"
                                        data={vendorHierarchy}
                                        columns={vendorHierarchyColumns}
                                        onrowaction={handleVendorHierarchyRowAction}
                                        expanded-rows={expandedVendorRows}
                                        hide-checkbox-column>
                                    </lightning-tree-grid>
                                </template>
                                <template if:false={vendorHierarchy.length}>
                                    <div class="slds-text-align_center slds-p-around_large">
                                        <p class="slds-text-body_regular">
                                            <template if:true={vendorSearchText}>
                                                No vendors or programs found matching "{vendorSearchText}".
                                            </template>
                                            <template if:false={vendorSearchText}>
                                                No vendors found. Click "Create New" to create a new vendor program.
                                            </template>
                                        </p>
                                    </div>
                                </template>
                            </template>
                        </template>
                    </template>

                    <!-- Vendor Selection Step: Select or Create Vendor -->
                    <template if:true={isVendorSelectionStep}>
                        <p class="slds-text-body_regular slds-m-bottom_medium">
                            Select an existing vendor or create a new one to continue with vendor program creation.
                        </p>
                        
                        <!-- Search Existing Vendors -->
                        <div class="slds-form-element slds-m-bottom_medium">
                            <label class="slds-form-element__label" for="vendor-search">
                                Search for Existing Vendor
                            </label>
                            <div class="slds-form-element__control">
                                <div class="slds-grid slds-gutter_x-small">
                                    <div class="slds-col slds-size_3-of-4">
                                        <lightning-input
                                            id="vendor-search"
                                            type="text"
                                            value={vendorSearchText}
                                            onchange={handleVendorSearchChange}
                                            placeholder="Enter vendor name">
                                        </lightning-input>
                                    </div>
                                    <div class="slds-col slds-size_1-of-4">
                                        <lightning-button
                                            label="Search"
                                            variant="neutral"
                                            onclick={handleSearchVendors}
                                            disabled={isVendorSearching}
                                            icon-name="utility:search">
                                        </lightning-button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Vendor Search Results -->
                        <template if:true={vendors.length}>
                            <div class="slds-form-element slds-m-bottom_medium">
                                <label class="slds-form-element__label">
                                    <abbr class="slds-required" title="required">*</abbr> Select Vendor
                                </label>
                                <div class="slds-form-element__control">
                                    <lightning-radio-group
                                        name="vendor-selection"
                                        options={vendorOptions}
                                        value={selectedVendorId}
                                        type="radio"
                                        onchange={handleVendorSelect}>
                                    </lightning-radio-group>
                                </div>
                            </div>
                        </template>

                        <!-- Or Create New Vendor -->
                        <div class="slds-divider slds-m-vertical_medium">
                            <span class="slds-text-body_small slds-p-horizontal_medium">OR</span>
                        </div>

                        <div class="slds-form-element slds-m-bottom_medium">
                            <label class="slds-form-element__label" for="new-vendor-name">
                                Create New Vendor
                            </label>
                            <div class="slds-form-element__control">
                                <div class="slds-grid slds-gutter_x-small">
                                    <div class="slds-col slds-size_3-of-4">
                                        <lightning-input
                                            id="new-vendor-name"
                                            type="text"
                                            value={newVendorName}
                                            onchange={handleCreateVendorChange}
                                            placeholder="Enter new vendor name">
                                        </lightning-input>
                                    </div>
                                    <div class="slds-col slds-size_1-of-4">
                                        <lightning-button
                                            label="Create"
                                            variant="neutral"
                                            onclick={handleCreateVendor}
                                            disabled={isCreatingVendor}
                                            icon-name="utility:add">
                                        </lightning-button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Selected Vendor Display -->
                        <template if:true={selectedVendorId}>
                            <div class="slds-box slds-theme_success slds-m-top_medium">
                                <div class="slds-media">
                                    <div class="slds-media__figure">
                                        <lightning-icon icon-name="utility:success" size="small"></lightning-icon>
                                    </div>
                                    <div class="slds-media__body">
                                        <p class="slds-text-body_small">
                                            <strong>Vendor Selected:</strong> 
                                            <template if:true={selectedVendorId}>
                                                {selectedVendorName}
                                            </template>
                                        </p>
                                    </div>
                                </div>
                            </div>
                        </template>
                    </template>

                    <!-- Vendor Program Selection Step: Select Existing Vendor Program -->
                    <template if:true={isVendorProgramSelectionStep}>
                        <p class="slds-text-body_regular slds-m-bottom_medium">
                            Select an existing vendor program to continue onboarding or make updates.
                        </p>
                        
                        <!-- Recent Vendor Programs -->
                        <template if:true={recentVendorPrograms.length}>
                            <div class="slds-form-element slds-m-bottom_medium">
                                <label class="slds-form-element__label">
                                    Recent Vendor Programs
                                </label>
                                <div class="slds-form-element__control">
                                    <lightning-radio-group
                                        name="recent-vendor-program-selection"
                                        options={recentVendorProgramOptions}
                                        value={selectedVendorProgramId}
                                        type="radio"
                                        onchange={handleVendorProgramSelect}>
                                    </lightning-radio-group>
                                </div>
                            </div>
                        </template>

                        <!-- Search Vendor Programs -->
                        <div class="slds-form-element slds-m-bottom_medium">
                            <label class="slds-form-element__label" for="vendor-program-search">
                                Search for Vendor Program
                            </label>
                            <div class="slds-form-element__control">
                                <div class="slds-grid slds-gutter_x-small">
                                    <div class="slds-col slds-size_3-of-4">
                                        <lightning-input
                                            id="vendor-program-search"
                                            type="text"
                                            value={vendorProgramSearchText}
                                            onchange={handleVendorProgramSearchChange}
                                            placeholder="Enter vendor program name">
                                        </lightning-input>
                                    </div>
                                    <div class="slds-col slds-size_1-of-4">
                                        <lightning-button
                                            label="Search"
                                            variant="neutral"
                                            onclick={handleSearchVendorPrograms}
                                            disabled={isVendorProgramSearching}
                                            icon-name="utility:search">
                                        </lightning-button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Vendor Program Search Results -->
                        <template if:true={vendorPrograms.length}>
                            <div class="slds-form-element slds-m-bottom_medium">
                                <label class="slds-form-element__label">
                                    <abbr class="slds-required" title="required">*</abbr> Select Vendor Program
                                </label>
                                <div class="slds-form-element__control">
                                    <lightning-radio-group
                                        name="vendor-program-selection"
                                        options={vendorProgramOptions}
                                        value={selectedVendorProgramId}
                                        type="radio"
                                        onchange={handleVendorProgramSelect}>
                                    </lightning-radio-group>
                                </div>
                            </div>
                        </template>
                    </template>
                </div>
                <footer class="slds-modal__footer">
                    <template if:false={isTreeGridStep}>
                        <lightning-button 
                            variant="neutral" 
                            label="Back" 
                            onclick={handleBackToTreeGrid}
                            class="slds-m-right_small">
                        </lightning-button>
                    </template>
                    <lightning-button 
                        variant="neutral" 
                        label="Cancel" 
                        onclick={handleCloseVendorProgramModal}>
                    </lightning-button>
                    <template if:true={isVendorSelectionStep}>
                        <lightning-button 
                            variant="brand" 
                            label="Continue" 
                            onclick={handleProceedWithVendor}
                            disabled={cannotProceedWithVendor}>
                        </lightning-button>
                    </template>
                    <template if:true={isVendorProgramSelectionStep}>
                        <lightning-button 
                            variant="brand" 
                            label="Continue" 
                            onclick={handleProceedWithVendorProgram}
                            disabled={cannotProceedWithVendorProgram}>
                        </lightning-button>
                    </template>
                </footer>
            </div>
        </section>
        <div class="slds-backdrop slds-backdrop_open"></div>
    </template>

    <!-- Start Onboarding Modal -->
    <template if:true={showStartModal}>
        <section role="dialog" tabindex="-1" aria-labelledby="modal-heading-01" aria-modal="true" aria-describedby="modal-content-id-1" class="slds-modal slds-fade-in-open">
            <div class="slds-modal__container">
                <header class="slds-modal__header">
                    <button class="slds-button slds-button_icon slds-modal__close slds-button_icon-inverse" title="Close" onclick={handleCloseModal}>
                        <lightning-icon icon-name="utility:close" alternative-text="close" size="small"></lightning-icon>
                        <span class="slds-assistive-text">Close</span>
                    </button>
                    <h2 id="modal-heading-01" class="slds-modal__title slds-hyphenate">Start Dealer Onboarding</h2>
                </header>
                <div class="slds-modal__content slds-p-around_medium" id="modal-content-id-1">
                    <p class="slds-text-body_regular slds-m-bottom_medium">
                        Select an account (dealer) to start onboarding for vendor programs. You can also use the Eligible Accounts table below to find accounts with available vendor programs.
                    </p>
                    <div class="slds-form-element slds-m-bottom_medium">
                        <label class="slds-form-element__label" for="account-select">
                            <abbr class="slds-required" title="required">*</abbr> Select Account
                        </label>
                        <div class="slds-form-element__control">
                            <lightning-combobox
                                id="account-select"
                                label="Account"
                                value={selectedAccountId}
                                options={eligibleAccountsOptions}
                                onchange={handleAccountSelect}
                                placeholder="Select an account">
                            </lightning-combobox>
                        </div>
                    </div>
                </div>
                <footer class="slds-modal__footer">
                    <lightning-button variant="neutral" label="Cancel" onclick={handleCloseModal}></lightning-button>
                    <lightning-button variant="brand" label="Start Dealer Onboarding" onclick={handleConfirmStart}></lightning-button>
                </footer>
            </div>
        </section>
        <div class="slds-backdrop slds-backdrop_open"></div>
    </template>

    <!-- Vendor Program Onboarding Wizard Modal -->
    <template if:true={showWizardModal}>
        <c-vendor-program-onboarding-wizard-modal
            vendor-program-id={wizardVendorProgramId}
            onclose={handleCloseWizardModal}
            oncomplete={handleWizardComplete}>
        </c-vendor-program-onboarding-wizard-modal>
    </template>
</template>
