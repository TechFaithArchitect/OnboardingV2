<template>
    <lightning-card>
        <!-- Header Section -->
        <div class="slds-p-horizontal_medium slds-p-top_medium">
            <div class="slds-grid slds-grid_align-spread slds-m-bottom_medium">
                <div>
                    <h1 class="slds-text-heading_large">Onboarding Home</h1>
                    <p class="slds-text-body_small slds-text-color_weak slds-m-top_xx-small">
                        Dealer & Vendor Program Onboarding Overview
                    </p>
                </div>
                <div>
                    <c-onboarding-filter-chips
                        time-filter={filters.timeRange}
                        vendor-filter={filters.vendors}
                        program-filter={filters.programs}
                        view-filter={filters.view}
                        show-team-view={showTeamView}
                        onfilterchange={handleFilterChange}>
                    </c-onboarding-filter-chips>
                </div>
            </div>

            <!-- Quick Actions -->
            <div class="slds-grid slds-gutter slds-m-bottom_medium">
                <div class="slds-col slds-size_1-of-1">
                    <lightning-button 
                        label="Start Onboarding Vendor Program" 
                        variant="brand" 
                        icon-name="utility:add"
                        onclick={handleStartVendorProgramOnboarding}
                        class="slds-m-right_small">
                    </lightning-button>
                    <lightning-button 
                        label="Start Dealer Onboarding" 
                        variant="brand" 
                        icon-name="utility:user"
                        onclick={handleStartDealerOnboarding}
                        class="slds-m-right_small">
                    </lightning-button>
                    <lightning-button 
                        label="Sync Component Library" 
                        variant="neutral" 
                        icon-name="utility:sync"
                        onclick={handleSyncComponentLibrary}
                        disabled={isSyncingComponentLibrary}
                        title="Populates Onboarding_Component_Library__c with all 14 wizard components"
                        class="slds-m-right_small">
                    </lightning-button>
                    <lightning-button 
                        label="Initialize Default Process" 
                        variant="neutral" 
                        icon-name="utility:flow"
                        onclick={handleInitializeDefaultProcess}
                        disabled={isInitializingProcess}
                        title="Creates the default 'Vendor Program Onboarding' process with all 14 stages if it doesn't exist"
                        class="slds-m-right_small">
                    </lightning-button>
                    <lightning-button 
                        label="Refresh" 
                        variant="neutral" 
                        icon-name="utility:refresh"
                        onclick={handleRefresh}>
                    </lightning-button>
                </div>
            </div>
        </div>

        <!-- Loading Spinner -->
        <template if:true={isLoading}>
            <div class="slds-align_absolute-center slds-p-around_large">
                <lightning-spinner alternative-text="Loading..." size="medium"></lightning-spinner>
            </div>
        </template>

        <!-- Dashboard Content -->
        <template if:false={isLoading}>
            <!-- KPI Row -->
            <c-onboarding-kpi-row
                summary={onboardingSummary}
                vendor-summary={vendorSummary}
                blocked-count={blockedCount}
                ontileclick={handleKpiTileClick}>
            </c-onboarding-kpi-row>

            <!-- Main Content Area with Tabs -->
            <div class="slds-grid slds-gutters_medium slds-p-horizontal_medium">
                <!-- Main Content (2/3 width) -->
                <div class="slds-col slds-size_2-of-3">
                    <lightning-tabset active-tab-value={activeTab} onactive={handleTabChange}>
                        <lightning-tab label="My Active Onboarding" value="my-onboarding">
                            <c-onboarding-work-queue
                                records={activeOnboarding}
                                show-blocking-indicators={showBlockingIndicators}
                                onview={handleViewOnboarding}
                                onresume={handleResumeOnboarding}
                                onviewrequirements={handleViewRequirements}>
                            </c-onboarding-work-queue>
                        </lightning-tab>

                        <lightning-tab label="Eligible Dealers" value="eligible">
                            <lightning-datatable
                                key-field="Id"
                                data={eligibleAccounts}
                                columns={eligibleAccountsColumns}
                                onrowaction={handleEligibleAccountsRowAction}
                                hide-checkbox-column
                                show-row-number-column>
                            </lightning-datatable>
                        </lightning-tab>

                        <lightning-tab label="Vendor Programs" value="programs">
                            <c-onboarding-vendor-program-grid
                                programs={vendorPrograms}
                                onviewprogram={handleViewProgram}
                                onlaunchwizard={handleLaunchWizard}>
                            </c-onboarding-vendor-program-grid>
                        </lightning-tab>

                        <template if:true={showTeamTab}>
                            <lightning-tab label="Team / Org Queue" value="team">
                                <c-onboarding-work-queue
                                    records={teamQueue}
                                    show-blocking-indicators={showBlockingIndicators}
                                    onview={handleViewOnboarding}
                                    onresume={handleResumeOnboarding}
                                    onviewrequirements={handleViewRequirements}>
                                </c-onboarding-work-queue>
                            </lightning-tab>
                        </template>

                        <lightning-tab label="Insights" value="insights">
                            <template if:true={hasInsightsComponent}>
                                <c-onboarding-insights
                                    summary={onboardingSummary}
                                    vendor-program-metrics={vendorProgramMetrics}>
                                </c-onboarding-insights>
                            </template>
                            <template if:false={hasInsightsComponent}>
                                <div class="slds-text-align_center slds-p-around_large">
                                    <p class="slds-text-body_regular">Insights coming soon.</p>
                                </div>
                            </template>
                        </lightning-tab>
                    </lightning-tabset>
                </div>

                <!-- Sidebar (1/3 width) -->
                <div class="slds-col slds-size_1-of-3">
                    <lightning-card title="Recent Activity" icon-name="utility:clock">
                        <c-onboarding-recent-activity
                            activities={recentActivity}
                            onview={handleViewOnboarding}>
                        </c-onboarding-recent-activity>
                    </lightning-card>
                </div>
            </div>

            <!-- Admin Configuration Shortcuts -->
            <template if:true={showAdminSection}>
                <c-onboarding-admin-tools-panel></c-onboarding-admin-tools-panel>
            </template>

            <!-- Messaging Issues (non-admin view) -->
            <template if:false={showAdminSection}>
                <div class="slds-p-horizontal_medium slds-m-vertical_large">
                    <lightning-card title="Messaging Issues" icon-name="utility:warning">
                        <div class="slds-p-around_medium">
                            <c-messaging-issues-panel></c-messaging-issues-panel>
                            <div class="slds-m-top_medium slds-text-align_right">
                                <lightning-button variant="neutral" label="Open List" icon-name="utility:list" onclick={navigateToMessagingIssuesList}></lightning-button>
                            </div>
                        </div>
                    </lightning-card>
                    <lightning-card title="Follow-Up Lists" icon-name="utility:list" class="slds-m-top_medium">
                        <div class="slds-p-around_medium slds-grid slds-wrap slds-gutters_small">
                            <div class="slds-col slds-size_1-of-2 slds-large-size_1-of-4">
                                <lightning-button variant="neutral" label="Pending" class="slds-m-bottom_small" onclick={handleViewPending}></lightning-button>
                            </div>
                            <div class="slds-col slds-size_1-of-2 slds-large-size_1-of-4">
                                <lightning-button variant="neutral" label="Pending Retry" class="slds-m-bottom_small" onclick={handleViewPendingRetry}></lightning-button>
                            </div>
                            <div class="slds-col slds-size_1-of-2 slds-large-size_1-of-4">
                                <lightning-button variant="neutral" label="Failed" class="slds-m-bottom_small" onclick={handleViewFailed}></lightning-button>
                            </div>
                            <div class="slds-col slds-size_1-of-2 slds-large-size_1-of-4">
                                <lightning-button variant="neutral" label="Due Today" class="slds-m-bottom_small" onclick={handleViewDueToday}></lightning-button>
                            </div>
                        </div>
                    </lightning-card>
                </div>
            </template>
        </template>
    </lightning-card>

    <!-- Vendor Program Onboarding Modal -->
    <template if:true={showVendorProgramModal}>
        <c-onboarding-vendor-program-wizard
            onclose={handleVendorProgramModalClose}
            onlaunchwizard={handleVendorProgramWizardLaunch}>
        </c-onboarding-vendor-program-wizard>
    </template>

    <!-- Start Onboarding Modal -->
    <template if:true={showStartModal}>
        <c-onboarding-dealer-onboarding-modal
            eligible-accounts={eligibleAccounts}
            onstart={handleDealerOnboardingStart}
            onclose={handleDealerOnboardingClose}>
        </c-onboarding-dealer-onboarding-modal>
    </template>

    <!-- Vendor Program Onboarding Wizard Modal -->
    <template if:true={showWizardModal}>
        <c-vendor-program-onboarding-wizard-modal
            vendor-program-id={wizardVendorProgramId}
            onclose={handleCloseWizardModal}
            oncomplete={handleWizardComplete}>
        </c-vendor-program-onboarding-wizard-modal>
    </template>
</template>
