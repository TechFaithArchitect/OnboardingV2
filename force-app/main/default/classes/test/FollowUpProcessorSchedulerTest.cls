/**
 * Test class for FollowUpProcessorBatchScheduler
 */
@isTest
private class FollowUpProcessorBatchSchedulerTest {

    @isTest
    static void testBatchProcessing() {
        // Create test data
        Account testAccount = TestDataFactory.createAccount('Test Account', true);
        Vendor__c testVendor = TestDataFactory.createVendor(true);
        Vendor_Customization__c testProgram = TestDataFactory.createVendorCustomization(
            testVendor, 'Active', true, null, true
        );
        Onboarding__c testOnboarding = TestDataFactory.createOnboarding(testAccount, testProgram, true);
        Onboarding_Requirement__c testRequirement = TestOnboardingRequirementFactory.create(
            true, testOnboarding, null
        );

        // Create follow-up queue records that are due
        List<Follow_Up_Queue__c> followUps = new List<Follow_Up_Queue__c>();
        for (Integer i = 0; i < 5; i++) {
            followUps.add(new Follow_Up_Queue__c(
                Onboarding_Requirement__c = testRequirement.Id,
                Onboarding__c = testOnboarding.Id,
                Follow_Up_Type__c = 'Email', // Use Email to avoid SMS API issues in test
                Status__c = 'Pending',
                Next_Attempt_Date__c = DateTime.now().addMinutes(-10), // Due 10 minutes ago
                Attempt_Count__c = 0,
                Fatigue_Suppressed__c = false
            ));
        }
        insert followUps;

        Test.startTest();
        FollowUpProcessorScheduler scheduler = new FollowUpProcessorScheduler();
        Database.executeBatch(scheduler, 50);
        Test.stopTest();

        // Verify follow-ups were processed
        List<Follow_Up_Queue__c> updated = [
            SELECT Id, Status__c, Last_Attempt_Date__c, Attempt_Count__c
            FROM Follow_Up_Queue__c
            WHERE Id IN :followUps
        ];

        System.assertEquals(5, updated.size(), 'All follow-ups should be processed');
        for (Follow_Up_Queue__c fq : updated) {
            // Status should be updated (Sent or Failed depending on execution)
            System.assertNotEquals('Pending', fq.Status__c, 'Follow-up should be processed');
            System.assertNotEquals(null, fq.Last_Attempt_Date__c, 'Attempt date should be set');
        }
    }

    @isTest
    static void testSuppressedFollowUps() {
        // Create test data
        Account testAccount = TestDataFactory.createAccount('Test Account', true);
        Vendor__c testVendor = TestDataFactory.createVendor(true);
        Vendor_Customization__c testProgram = TestDataFactory.createVendorCustomization(
            testVendor, 'Active', true, null, true
        );
        Onboarding__c testOnboarding = TestDataFactory.createOnboarding(testAccount, testProgram, true);
        Onboarding_Requirement__c testRequirement = TestOnboardingRequirementFactory.create(
            true, testOnboarding, null
        );

        // Create suppressed follow-up
        Follow_Up_Queue__c followUp = new Follow_Up_Queue__c(
            Onboarding_Requirement__c = testRequirement.Id,
            Onboarding__c = testOnboarding.Id,
            Follow_Up_Type__c = 'Email',
            Status__c = 'Pending',
            Next_Attempt_Date__c = DateTime.now().addMinutes(-10),
            Attempt_Count__c = 2,
            Fatigue_Suppressed__c = true
        );
        insert followUp;

        Test.startTest();
        FollowUpProcessorScheduler scheduler = new FollowUpProcessorScheduler();
        Database.executeBatch(scheduler, 50);
        Test.stopTest();

        // Verify suppressed follow-up was skipped but next attempt date updated
        Follow_Up_Queue__c updated = [
            SELECT Id, Status__c, Next_Attempt_Date__c, Attempt_Count__c
            FROM Follow_Up_Queue__c
            WHERE Id = :followUp.Id
        ];

        System.assertEquals('Pending', updated.Status__c, 'Suppressed follow-up should remain Pending');
        System.assertNotEquals(null, updated.Next_Attempt_Date__c, 'Next attempt date should be updated');
    }

    @isTest
    static void testSchedulable() {
        Test.startTest();
        String jobId = FollowUpProcessorBatchScheduler.scheduleHourly();
        Test.stopTest();

        System.assertNotEquals(null, jobId, 'Scheduled job should be created');
        
        // Verify job was scheduled
        List<CronTrigger> jobs = [
            SELECT Id, CronJobDetail.Name
            FROM CronTrigger
            WHERE Id = :jobId
        ];
        System.assertEquals(1, jobs.size(), 'Job should be scheduled');
    }
}

